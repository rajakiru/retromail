<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Mail Club - Kiru & Aadya</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Caveat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cream: #F7F2EA;
            --dusty-blue: #7FA3B2;
            --warm-yellow: #F1C96B;
            --kraft: #D4B89B;
            --faded-rose: #C98088;
            --ink: #3B3A39;
            --moss: #6C7A5C;
            --paper-shadow: rgba(0,0,0,.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Special Elite", "Courier New", monospace;
            background: linear-gradient(135deg, var(--cream) 0%, #F0EBE3 100%);
            color: var(--ink);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 50%, transparent 20%, rgba(0,0,0,0.02) 21%, rgba(0,0,0,0.02) 34%, transparent 35%, transparent),
                linear-gradient(0deg, transparent 24%, rgba(0,0,0,0.01) 25%, rgba(0,0,0,0.01) 26%, transparent 27%, transparent 74%, rgba(0,0,0,0.01) 75%, rgba(0,0,0,0.01) 76%, transparent 77%, transparent);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .club-title {
            font-family: "Caveat", cursive;
            font-size: 2.5rem;
            color: var(--moss);
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px var(--paper-shadow);
        }

        .privacy-label {
            font-size: 0.9rem;
            color: var(--dusty-blue);
            opacity: 0.8;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Mailbox View */
        .mailbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            margin-top: 40px;
        }

        .envelope {
            position: relative;
            width: 500px;
            height: 320px;
            background: var(--kraft);
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--paper-shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }

        .envelope:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px var(--paper-shadow);
        }

        .envelope-front {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--kraft);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .envelope-flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, var(--kraft) 0%, #C9A98A 100%);
            clip-path: polygon(0 0, 100% 0, 85% 100%, 15% 100%);
            transform-origin: top center;
            transition: transform 0.6s cubic-bezier(.2,.7,.2,1);
            z-index: 3;
            border-radius: 12px 12px 0 0;
        }

        .envelope.opening .envelope-flap {
            transform: rotateX(-120deg);
        }

        .wax-seal {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: var(--faded-rose);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4;
            transition: all 0.3s ease;
        }

        .wax-seal::after {
            content: "‚òÖ";
            color: var(--cream);
            font-size: 18px;
        }

        .addressee {
            font-family: "Caveat", cursive;
            font-size: 2rem;
            color: var(--ink);
            text-align: center;
            margin-top: 150px;
            z-index: 1;
            position: relative;
        }

        .postage-area {
            position: absolute;
            top: 40px;
            right: 40px;
            width: 90px;
            height: 90px;
            border: 3px dashed var(--dusty-blue);
            border-radius: 8px;
            opacity: 0.4;
            z-index: 1;
        }

        .stamp {
            position: absolute;
            width: 45px;
            height: 45px;
            background: var(--warm-yellow);
            border: 3px solid white;
            border-radius: 3px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 8px var(--paper-shadow);
            transition: transform 0.2s ease;
            z-index: 10;
            user-select: none;
        }

        .stamp:hover {
            transform: scale(1.1) rotate(2deg);
        }

        .stamp.dragging {
            cursor: grabbing;
            transform: scale(1.2) rotate(5deg);
            z-index: 20;
        }

        .stamp.on-envelope {
            position: absolute;
            z-index: 2;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stamp.on-envelope:hover {
            transform: scale(1.1) rotate(0deg) !important;
            box-shadow: 0 4px 12px var(--paper-shadow);
            filter: brightness(1.1);
        }

        .stamp.on-envelope:hover::after {
            content: "‚úï";
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: var(--faded-rose);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .stamps-tray {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-family: "Special Elite", monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 12px var(--paper-shadow);
        }

        .btn-primary {
            background: var(--dusty-blue);
            color: white;
        }

        .btn-secondary {
            background: var(--warm-yellow);
            color: var(--ink);
        }

        .btn-tertiary {
            background: var(--moss);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--paper-shadow);
        }

        .user-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--faded-rose);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            font-family: "Caveat", cursive;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-toggle:hover {
            background: #B8707A;
            transform: scale(1.05);
        }

        .unread-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--faded-rose);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 4;
        }

        /* Letter View */
        .letter-view {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .letter-card {
            background: var(--cream);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 12px 40px var(--paper-shadow);
            position: relative;
            background-image: 
                repeating-linear-gradient(
                    transparent,
                    transparent 24px,
                    rgba(111, 122, 92, 0.1) 25px,
                    rgba(111, 122, 92, 0.1) 26px
                );
            max-height: 70vh;
            overflow-y: auto;
            animation: slideIn 0.8s cubic-bezier(.2,.7,.2,1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px) rotate(-2deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) rotate(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateY(0) rotate(0);
            }
            to {
                opacity: 0;
                transform: translateY(-30px) rotate(2deg);
            }
        }

        .letter-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--moss);
            border-bottom: 1px solid rgba(111, 122, 92, 0.2);
            padding-bottom: 10px;
        }

        .letter-body {
            font-family: "Caveat", cursive;
            font-size: 1.3rem;
            line-height: 1.8;
            color: var(--ink);
        }

        .letter-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: center;
        }

        /* Write View */
        .write-form {
            max-width: 600px;
            margin: 0 auto;
            background: var(--cream);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 12px 40px var(--paper-shadow);
            background-image: 
                repeating-linear-gradient(
                    transparent,
                    transparent 24px,
                    rgba(111, 122, 92, 0.1) 25px,
                    rgba(111, 122, 92, 0.1) 26px
                );
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: var(--moss);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--dusty-blue);
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            background: rgba(255,255,255,0.8);
        }

        .form-group textarea {
            font-family: "Caveat", cursive;
            font-size: 1.2rem;
            min-height: 200px;
            resize: vertical;
            line-height: 1.8;
        }

        /* Memory Box */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .memory-item {
            background: var(--kraft);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--paper-shadow);
            position: relative;
        }

        .memory-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--paper-shadow);
        }

        .memory-item h3 {
            font-family: "Caveat", cursive;
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--ink);
        }

        .memory-item p {
            font-size: 0.8rem;
            color: var(--moss);
            opacity: 0.8;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            border: 1px solid var(--dusty-blue);
            border-radius: 20px;
            font-family: inherit;
            margin-bottom: 20px;
        }

        /* Prompts View */
        .prompts-list {
            max-width: 600px;
            margin: 0 auto;
        }

        .prompt-card {
            background: var(--warm-yellow);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px var(--paper-shadow);
        }

        .prompt-title {
            font-family: "Caveat", cursive;
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: var(--ink);
        }

        .prompt-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--moss);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--paper-shadow);
            z-index: 1000;
            animation: toastSlide 3s ease-in-out;
        }

        @keyframes toastSlide {
            0%, 100% { transform: translateX(300px); opacity: 0; }
            10%, 90% { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .envelope {
                width: 450px;
                height: 280px;
            }
            
            .club-title {
                font-size: 2rem;
            }
            
            .letter-card,
            .write-form {
                padding: 20px;
                margin: 10px;
            }
            
            .nav-buttons {
                gap: 10px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .envelope-flap {
                transition: none;
            }
            
            .letter-card {
                animation: none;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        .btn:focus,
        .envelope:focus,
        .memory-item:focus,
        .stamp:focus {
            outline: 2px solid var(--dusty-blue);
            outline-offset: 2px;
        }

        input:focus,
        textarea:focus {
            outline: 2px solid var(--dusty-blue);
            outline-offset: 1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="user-toggle" onclick="toggleUser()" aria-label="Switch user">I'm <span id="current-user">Kiru</span></button>
        
        <div class="header">
            <h1 class="club-title">Digital Mail Club</h1>
            <p class="privacy-label">Private club for Kiru ‚Üî Aadya</p>
        </div>

        <div id="mailbox-view" class="view active">
            <div class="mailbox">
                <div class="envelope" onclick="openLetter()" ondrop="dropStamp(event)" ondragover="allowDrop(event)" role="button" tabindex="0" aria-expanded="false" aria-label="Open letter">
                    <div class="envelope-front">
                        <div class="postage-area"></div>
                        <div class="addressee">To: <span id="envelope-addressee">Aadya</span></div>
                    </div>
                    <div class="envelope-flap"></div>
                    <div class="wax-seal"></div>
                    <div class="unread-badge" id="unread-count">1</div>
                </div>

                <div class="stamps-tray">
                    <div class="stamp" draggable="true" ondragstart="dragStart(event)" data-stamp="üìÆ">üìÆ</div>
                    <div class="stamp" draggable="true" ondragstart="dragStart(event)" data-stamp="üåü">üåü</div>
                    <div class="stamp" draggable="true" ondragstart="dragStart(event)" data-stamp="üçÉ">üçÉ</div>
                    <div class="stamp" draggable="true" ondragstart="dragStart(event)" data-stamp="üíå">üíå</div>
                    <div class="stamp" draggable="true" ondragstart="dragStart(event)" data-stamp="üåô">üåô</div>
                    <div class="stamp" draggable="true" ondragstart="dragStart(event)" data-stamp="üïäÔ∏è">üïäÔ∏è</div>
                    <div class="stamp" draggable="true" ondragstart="dragStart(event)" data-stamp="üåª">üåª</div>
                    <div class="stamp" draggable="true" ondragstart="dragStart(event)" data-stamp="ü¶ã">ü¶ã</div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="showView('write')">Write New</button>
                    <button class="btn btn-secondary" onclick="showView('prompts')">Weekly Prompts</button>
                    <button class="btn btn-tertiary" onclick="showView('memory')">Memory Box</button>
                    <button class="btn" onclick="clearAllStamps()" style="background: var(--faded-rose); color: white;">Clear Stamps</button>
                </div>
            </div>
        </div>

        <div id="letter-view" class="view">
            <div class="letter-view">
                <div class="letter-card" id="letter-content">
                    </div>
                <div class="letter-actions">
                    <button class="btn btn-secondary" onclick="replyToLetter()">Reply</button>
                    <button class="btn btn-primary" onclick="closeLetter()">Close Letter</button>
                    <button class="btn btn-tertiary" onclick="saveToMemory()">Save to Memory Box</button>
                </div>
            </div>
        </div>

        <div id="write-view" class="view">
            <div class="write-form">
                <h2>Write a Letter</h2>
                <form id="letter-form" onsubmit="sendLetter(event)">
                    <div class="form-group">
                        <label for="to-field">To:</label>
                        <input type="text" id="to-field" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="subject-field">Subject:</label>
                        <input type="text" id="subject-field" required>
                    </div>
                    <div class="form-group">
                        <label for="body-field">Your Letter:</label>
                        <textarea id="body-field" required placeholder="Dear friend..."></textarea>
                    </div>
                    <div class="nav-buttons">
                        <button type="submit" class="btn btn-primary">Seal & Send</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelWriting()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="prompts-view" class="view">
            <div class="prompts-list">
                <h2>Weekly Prompts</h2>
                <div id="prompts-container">
                    </div>
                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="showView('mailbox')">Back to Mailbox</button>
                </div>
            </div>
        </div>

        <div id="memory-view" class="view">
            <h2>Memory Box</h2>
            <input type="text" class="search-box" placeholder="Search letters..." oninput="filterMemories(this.value)">
            <div class="filters">
                <button class="btn btn-secondary" onclick="setFilter('all')">All</button>
                <button class="btn btn-secondary" onclick="setFilter('letter')">Letters</button>
                <button class="btn btn-secondary" onclick="setFilter('prompt')">Prompts</button>
            </div>
            <div class="memory-grid" id="memory-grid">
                </div>
            <div class="nav-buttons">
                <button class="btn btn-primary" onclick="showView('mailbox')">Back to Mailbox</button>
            </div>
        </div>
    </div>

    <script>
        // App state
        let state = {
            letters: [],
            collectibles: { stampsUnlocked: ['üìÆ', 'üåü', 'üçÉ', 'üíå'] },
            user: { name: 'Kiru' },
            currentLetter: null,
            currentFilter: 'all'
        };

        // Weekly prompts
        const weeklyPrompts = [
            "A memory you return to when you can't sleep.",
            "Write a letter to future-you in one year.",
            "A film/book that held your hand lately.",
        ];

        // Seed data
        function initializeApp() {
            const savedState = localStorage.getItem('digitalMailClub');
            if (savedState) {
                state = JSON.parse(savedState);
            } else {
                // Seed with sample letters
                state.letters = [
                    {
                        id: 'seed1',
                        from: 'Aadya',
                        to: 'Kiru',
                        subject: 'Prompt #2 Response',
                        body: `Romantic relaiship is based around building a life together and platonic is supporting whatever life u already had. is that true? I don't understand how people don't want to center their lives around friends, am I absurd? maybe this is our answer though, bc in the society we live in now, isn't the only option a romantic relationship?\n\nA.`,
                        dateISO: '2025-01-15T14:30:00Z',
                        type: 'letter',
                        stamps: [],
                        attachments: []
                    },
                    {
                        id: 'seed2',
                        from: 'Aadya',
                        to: 'Kiru',
                        subject: 'Happy Birthday, Aadya!',
                        body: `dear aadya,\nhappy birthday!! i can‚Äôt believe i‚Äôm not next to you right now, helping with your decorations and everything. i keep wanting to just catch a flight ‚Äî or better yet, fly us both out to new york. you should actually plan a trip back to the us, we could escape for a weekend. stay with me for a month, i‚Äôd love that.\ni had all these gift ideas i thought of packing and sending, but the shipping costs were ridiculous. i even made a list. then i realized i don‚Äôt even have your current address, and you‚Äôre moving out by the end of this month anyway, so it wouldn‚Äôt work. send me your new one ‚Äî i‚Äôll try again.\nanyway, i‚Äôve been obsessed lately with the idea of mail clubs ‚Äî the way people send each other envelopes across the world, filled with favorite art, quotes, book recs, stickers. it‚Äôs so cute. i even looked up how much it costs to join one (there‚Äôs a duck mail club from canada, $15 plus shipping). but it made me think of us ‚Äî how we‚Äôve always had our own little exchange of letters and fragments. so i thought, why not make ours digital?\ni created this little space for us. i know, it‚Äôs ironic ‚Äî we always talk about how glued online we are, how scrolling replaces real connection, how there‚Äôs so little physical media around us anymore. but maybe that‚Äôs why i wanted to carve out this corner: not another feed, not another scroll, but a slower space that belongs just to us. inspired by beautiful world, where are you ‚Äî our own little club, where we can write to each other, drop in prompts, add polaroids, keep our fragments safe. this is just the first version. i‚Äôll make it better ‚Äî add stickers, little customizations, ways to pin in pieces of us.\nand I haven‚Äôt added all our past mails here yet. Right now its just a piece plucked out from the moment, but once I figure out a passcode or some sort of secret key, we can have a whole collection here, auto display these emails, add in polaroid, stickers, art, movie or book quotes.\nLots of love,\nKiruuuu`,
                        dateISO: '2025-01-18T16:45:00Z',
                        type: 'prompt',
                        promptId: '2',
                        stamps: [],
                        attachments: []
                    }
                ];
                saveState();
            }
            
            updateUI();
            generateWeeklyPrompts();
        }

        function saveState() {
            localStorage.setItem('digitalMailClub', JSON.stringify(state));
        }

        function updateUI() {
            updateEnvelope();
            updateUserToggle();
            updateMemoryBox();
            updateUnreadCount();
        }

        function updateEnvelope() {
            const addressee = state.user.name === 'Kiru' ? 'Kiru' : 'Aadya';
            document.getElementById('envelope-addressee').textContent = addressee;
        }

        function updateUserToggle() {
            document.getElementById('current-user').textContent = state.user.name;
            updateEnvelope();
        }

        function updateUnreadCount() {
            const unreadCount = state.letters.filter(letter => 
                letter.to === state.user.name && !letter.read
            ).length;
            const badge = document.getElementById('unread-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function toggleUser() {
            state.user.name = state.user.name === 'Kiru' ? 'Aadya' : 'Kiru';
            saveState();
            updateUI();
        }

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewName + '-view').classList.add('active');

            if (viewName === 'write') {
                setupWriteForm();
            } else if (viewName === 'prompts') {
                generateWeeklyPrompts();
            } else if (viewName === 'memory') {
                updateMemoryBox();
            }
        }

        function openLetter() {
            const envelope = document.querySelector('.envelope');
            const unreadLetters = state.letters.filter(letter => 
                letter.to === state.user.name && !letter.read
            );

            if (unreadLetters.length > 0) {
                envelope.classList.add('opening');
                const letter = unreadLetters[0];
                letter.read = true;
                state.currentLetter = letter;
                saveState();

                setTimeout(() => {
                    displayLetter(letter);
                    showView('letter');
                    envelope.classList.remove('opening');
                }, 900);
            } else {
                // Show most recent letter if no unread ones
                if (state.letters.length > 0) {
                    const recentLetter = state.letters.sort((a, b) => 
                        new Date(b.dateISO) - new Date(a.dateISO)
                    )[0];
                    state.currentLetter = recentLetter;
                    displayLetter(recentLetter);
                    showView('letter');
                }
            }
        }

        function displayLetter(letter) {
            const content = document.getElementById('letter-content');
            const date = new Date(letter.dateISO).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let attachmentsHtml = '';
            if (letter.attachments && letter.attachments.length > 0) {
                attachmentsHtml = '<div style="margin-top: 20px;">';
                letter.attachments.forEach(attachment => {
                    if (attachment.type === 'photo') {
                        attachmentsHtml += `<div style="display: inline-block; margin: 5px; padding: 10px; background: white; box-shadow: 0 2px 8px var(--paper-shadow); transform: rotate(-2deg);"><img src="${attachment.srcOrText}" alt="Attached photo" style="max-width: 100px; max-height: 100px; border-radius: 4px;"></div>`;
                    }
                });
                attachmentsHtml += '</div>';
            }

            content.innerHTML = `
                <div class="letter-meta">
                    <div>From: <strong>${letter.from}</strong></div>
                    <div>${date}</div>
                </div>
                <h3 style="font-family: 'Caveat', cursive; font-size: 1.5rem; margin-bottom: 15px; color: var(--moss);">${letter.subject}</h3>
                <div class="letter-body">${letter.body.replace(/\n/g, '<br>')}</div>
                ${attachmentsHtml}
            `;
        }

        function setupWriteForm(isReply = false, originalLetter = null) {
            console.log('Setting up write form. Reply:', isReply);
            
            const toField = document.getElementById('to-field');
            const subjectField = document.getElementById('subject-field');
            const bodyField = document.getElementById('body-field');

            if (isReply && originalLetter) {
                toField.value = originalLetter.from;
                subjectField.value = originalLetter.subject.startsWith('Re: ') ? originalLetter.subject : `Re: ${originalLetter.subject}`;
                bodyField.value = `\n\n---\nReplying to: "${originalLetter.subject}" from ${originalLetter.from}`;
                bodyField.focus();
                bodyField.setSelectionRange(0, 0);
            } else {
                toField.value = state.user.name === 'Kiru' ? 'Aadya' : 'Kiru';
                subjectField.value = '';
                bodyField.value = '';
                bodyField.placeholder = 'Dear friend...';
                setTimeout(() => subjectField.focus(), 100);
            }
        }

        function closeLetter() {
            const letterCard = document.querySelector('.letter-card');
            if (letterCard) {
                letterCard.style.animation = 'slideOut 0.6s cubic-bezier(.2,.7,.2,1)';
                setTimeout(() => {
                    showView('mailbox');
                    letterCard.style.animation = ''; // Reset animation
                }, 500);
            } else {
                showView('mailbox');
            }
        }

        function sendLetter(event) {
            event.preventDefault();
            console.log('Sending letter...');
            
            const to = document.getElementById('to-field').value.trim();
            const subject = document.getElementById('subject-field').value.trim();
            const body = document.getElementById('body-field').value.trim();

            console.log('Form values:', { to, subject, body });

            if (!subject || !body) {
                showToast('Please fill in both subject and message');
                return false;
            }

            const newLetter = {
                id: 'letter_' + Date.now(),
                from: state.user.name,
                to: to,
                subject: subject,
                body: body,
                dateISO: new Date().toISOString(),
                type: subject.toLowerCase().includes('prompt #') ? 'prompt' : 'letter',
                stamps: [],
                attachments: [],
                read: false
            };

            state.letters.push(newLetter);
            saveState();
            console.log('Letter saved to state:', newLetter);

            // Show sealing animation/feedback
            const submitBtn = document.querySelector('#letter-form button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sealing...';
            
            showToast('Letter sealed and sent with love! üíå');
            
            // Reset form after short delay
            setTimeout(() => {
                resetWriteForm();
                showView('mailbox');
                updateUI();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Seal & Send';
            }, 1500);

            return false;
        }

        function resetWriteForm() {
            document.getElementById('subject-field').value = '';
            document.getElementById('body-field').value = '';
            document.getElementById('body-field').placeholder = 'Dear friend...';
            document.getElementById('letter-form').reset();
        }

        function cancelWriting() {
            resetWriteForm();
            showView('mailbox');
        }

        function saveToMemory() {
            if (state.currentLetter && !state.currentLetter.inMemory) {
                state.currentLetter.inMemory = true;
                saveState();
                updateMemoryBox();
                showToast('Saved to Memory Box');
            }
        }

        function updateMemoryBox() {
            const grid = document.getElementById('memory-grid');
            const savedLetters = state.letters.filter(letter => letter.inMemory);

            if (savedLetters.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; font-family: \'Caveat\', cursive; font-size: 1.2rem; color: var(--moss); opacity: 0.7;">No saved letters yet. The drawer waits patiently.</div>';
                return;
            }

            let filteredLetters = savedLetters;
            if (state.currentFilter !== 'all') {
                filteredLetters = savedLetters.filter(letter => letter.type === state.currentFilter);
            }

            grid.innerHTML = filteredLetters.map(letter => {
                const date = new Date(letter.dateISO).toLocaleDateString();
                return `
                    <div class="memory-item" onclick="openMemoryLetter('${letter.id}')" role="button" tabindex="0" onkeydown="if(event.key==='Enter') openMemoryLetter('${letter.id}')">
                        <h3>${letter.subject}</h3>
                        <p>From: ${letter.from} ‚Ä¢ ${date}</p>
                        <p>${letter.body.substring(0, 100)}${letter.body.length > 100 ? '...' : ''}</p>
                    </div>
                `;
            }).join('');
        }

        function openMemoryLetter(letterId) {
            const letter = state.letters.find(l => l.id === letterId);
            if (letter) {
                state.currentLetter = letter;
                displayLetter(letter);
                showView('letter');
            }
        }

        function setFilter(filterType) {
            state.currentFilter = filterType;
            updateMemoryBox();
            
            // Update button states
            document.querySelectorAll('.filters .btn').forEach(btn => {
                btn.style.background = 'var(--warm-yellow)';
            });
            event.target.style.background = 'var(--moss)';
            event.target.style.color = 'white';
        }

        function filterMemories(searchTerm) {
            const items = document.querySelectorAll('.memory-item');
            const term = searchTerm.toLowerCase();

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(term)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function generateWeeklyPrompts() {
            const container = document.getElementById('prompts-container');
            const today = new Date();
            const weekNumber = Math.floor((today - new Date(today.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
            const promptIndex = weekNumber % weeklyPrompts.length;
            const currentPrompt = weeklyPrompts[promptIndex];

            container.innerHTML = `
                <div class="prompt-card">
                    <div class="prompt-title">Week ${weekNumber + 1} Prompt</div>
                    <div class="prompt-text">${currentPrompt}</div>
                    <button class="btn btn-primary" onclick="respondToPrompt('${promptIndex}', '${currentPrompt}')">Write Response</button>
                </div>
            `;
        }

        function replyToLetter() {
            if (state.currentLetter) {
                setupWriteForm(true, state.currentLetter);
                showView('write');
            }
        }

        function respondToPrompt(promptId, promptText) {
            setupWriteForm();
            document.getElementById('subject-field').value = `Prompt #${parseInt(promptId) + 1} Response`;
            document.getElementById('body-field').placeholder = `Responding to: "${promptText}"\n\nYour thoughts...`;
            showView('write');
        }

        // Drag and drop functionality
        let draggedStamp = null;
        let draggedElement = null;

        function dragStart(event) {
            draggedStamp = event.target.dataset.stamp;
            draggedElement = event.target;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'copy';
        }

        function allowDrop(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        }

        function dropStamp(event) {
            event.preventDefault();
            event.stopPropagation(); // Prevent envelope click from firing
            
            if (draggedStamp) {
                const envelope = document.querySelector('.envelope');
                const rect = envelope.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                // Create a new stamp on the envelope
                const newStamp = document.createElement('div');
                newStamp.className = 'stamp on-envelope';
                newStamp.style.left = Math.max(5, Math.min(envelope.offsetWidth - 50, x - 22)) + 'px';
                newStamp.style.top = Math.max(5, Math.min(envelope.offsetHeight - 50, y - 22)) + 'px';
                newStamp.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
                newStamp.textContent = draggedStamp;
                newStamp.style.background = getRandomStampColor();
                newStamp.onclick = function(e) { 
                    e.stopPropagation(); 
                    removeStamp(newStamp);
                };
                
                envelope.appendChild(newStamp);

                // Save stamp position
                const stampId = Date.now() + Math.random();
                newStamp.dataset.stampId = stampId;
                saveStampPosition(stampId, draggedStamp, newStamp.style.left, newStamp.style.top, newStamp.style.transform);
                
                showToast(`${draggedStamp} stamp placed!`);
            }
            
            // Clean up
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            draggedStamp = null;
            draggedElement = null;
        }

        function getRandomStampColor() {
            const colors = ['var(--warm-yellow)', 'var(--dusty-blue)', 'var(--faded-rose)', 'var(--moss)', '#E6B3BA', '#A8DADC'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function saveStampPosition(stampId, stampEmoji, left, top, transform) {
            // Initialize stamps array if it doesn't exist
            if (!window.placedStamps) {
                window.placedStamps = [];
            }
            
            // Add new stamp position
            window.placedStamps.push({
                id: stampId,
                emoji: stampEmoji,
                left: left,
                top: top,
                transform: transform
            });
            
            // Save to localStorage
            localStorage.setItem('envelopeStamps', JSON.stringify(window.placedStamps));
        }

        function removeStamp(stampElement) {
            const stampId = stampElement.dataset.stampId;
            
            // Remove from DOM with animation
            stampElement.style.transition = 'all 0.3s ease';
            stampElement.style.transform = 'scale(0) rotate(180deg)';
            stampElement.style.opacity = '0';
            
            setTimeout(() => {
                if (stampElement.parentNode) {
                    stampElement.remove();
                }
            }, 300);
            
            // Remove from saved stamps
            if (window.placedStamps) {
                window.placedStamps = window.placedStamps.filter(s => s.id != stampId);
                localStorage.setItem('envelopeStamps', JSON.stringify(window.placedStamps));
            }
            
            showToast('Stamp removed!');
        }

        function clearAllStamps() {
            const envelope = document.querySelector('.envelope');
            const stamps = envelope.querySelectorAll('.stamp.on-envelope');
            
            stamps.forEach(stamp => {
                stamp.style.transition = 'all 0.3s ease';
                stamp.style.transform = 'scale(0) rotate(180deg)';
                stamp.style.opacity = '0';
            });
            
            setTimeout(() => {
                stamps.forEach(stamp => {
                    if (stamp.parentNode) {
                        stamp.remove();
                    }
                });
            }, 300);
            
            // Clear saved stamps
            window.placedStamps = [];
            localStorage.removeItem('envelopeStamps');
            
            showToast('All stamps cleared!');
        }

        function loadSavedStamps() {
            const saved = localStorage.getItem('envelopeStamps');
            if (saved) {
                window.placedStamps = JSON.parse(saved);
                const envelope = document.querySelector('.envelope');
                if (envelope && window.placedStamps) {
                    window.placedStamps.forEach(stampData => {
                        const stamp = document.createElement('div');
                        stamp.className = 'stamp on-envelope';
                        stamp.style.left = stampData.left;
                        stamp.style.top = stampData.top;
                        stamp.style.transform = stampData.transform;
                        stamp.style.background = getRandomStampColor();
                        stamp.textContent = stampData.emoji;
                        stamp.dataset.stampId = stampData.id;
                        stamp.onclick = function(e) { 
                            e.stopPropagation(); 
                            removeStamp(stamp);
                        };
                        envelope.appendChild(stamp);
                    });
                }
            }
        }

        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'polite');
            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Keyboard navigation
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const currentView = document.querySelector('.view.active');
                if (currentView.id === 'letter-view') {
                    closeLetter();
                } else {
                    showView('mailbox');
                }
            } else if (event.key === 'r' || event.key === 'R') {
                const currentView = document.querySelector('.view.active');
                if (currentView.id === 'letter-view' && state.currentLetter) {
                    replyToLetter();
                }
            }
        });

        // Clean up drag classes
        document.addEventListener('dragend', (event) => {
            if (event.target.classList.contains('stamp')) {
                event.target.classList.remove('dragging');
            }
        });

        // Prevent envelope opening when clicking on stamps
        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('on-envelope')) {
                event.stopPropagation();
            }
        });

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            // Clear all existing stamps first
            localStorage.removeItem('envelopeStamps');
            window.placedStamps = [];
            // Don't load any saved stamps
        });

        // Remove the sample stamp code since we're starting fresh
        setTimeout(() => {
            // Envelope starts clean - no default stamps
        }, 500);
    </script>
</body>
</html>