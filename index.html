
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Mail Club</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Caveat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cream: #F7F2EA;
            --dusty-blue: #7FA3B2;
            --warm-yellow: #F1C96B;
            --kraft: #D4B89B;
            --faded-rose: #C98088;
            --ink: #3B3A39;
            --moss: #6C7A5C;
            --paper-shadow: rgba(0,0,0,.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Special Elite", "Courier New", monospace;
            background: linear-gradient(135deg, var(--cream) 0%, #F0EBE3 100%);
            color: var(--ink);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .club-title {
            font-family: "Caveat", cursive;
            font-size: 2.5rem;
            color: var(--moss);
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px var(--paper-shadow);
        }

        .privacy-label {
            font-size: 0.9rem;
            color: var(--dusty-blue);
            opacity: 0.8;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Mailbox View */
        .mailbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            margin-top: 40px;
        }

        .envelope {
            position: relative;
            width: 500px;
            height: 320px;
            background: var(--kraft);
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--paper-shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }

        .envelope:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px var(--paper-shadow);
        }

        .envelope-front {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--kraft);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .envelope-flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, var(--kraft) 0%, #C9A98A 100%);
            clip-path: polygon(0 0, 100% 0, 85% 100%, 15% 100%);
            transform-origin: top center;
            transition: transform 0.6s cubic-bezier(.2,.7,.2,1);
            z-index: 3;
            border-radius: 12px 12px 0 0;
        }

        .envelope.opening .envelope-flap {
            transform: rotateX(-120deg);
        }

        .wax-seal {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: var(--faded-rose);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4;
            transition: all 0.3s ease;
        }

        .wax-seal::after {
            content: "★";
            color: var(--cream);
            font-size: 18px;
        }

        .addressee {
            font-family: "Caveat", cursive;
            font-size: 2rem;
            color: var(--ink);
            text-align: center;
            margin-top: 150px;
            z-index: 1;
            position: relative;
        }

        .postage-area {
            position: absolute;
            top: 40px;
            right: 40px;
            width: 90px;
            height: 90px;
            border: 3px dashed var(--dusty-blue);
            border-radius: 8px;
            opacity: 0.4;
            z-index: 1;
        }

        .unread-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--faded-rose);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 4;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-family: "Special Elite", monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 12px var(--paper-shadow);
        }

        .btn-primary {
            background: var(--dusty-blue);
            color: white;
        }

        .btn-secondary {
            background: var(--warm-yellow);
            color: var(--ink);
        }

        .btn-tertiary {
            background: var(--moss);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--paper-shadow);
        }

        /* Letter View */
        .letter-view {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .letter-card {
            background: var(--cream);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 12px 40px var(--paper-shadow);
            position: relative;
            background-image: 
                repeating-linear-gradient(
                    transparent,
                    transparent 24px,
                    rgba(111, 122, 92, 0.1) 25px,
                    rgba(111, 122, 92, 0.1) 26px
                );
            max-height: 70vh;
            overflow-y: auto;
            animation: slideIn 0.8s cubic-bezier(.2,.7,.2,1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px) rotate(-2deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) rotate(0);
            }
        }

        .letter-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--moss);
            border-bottom: 1px solid rgba(111, 122, 92, 0.2);
            padding-bottom: 10px;
        }

        .letter-body {
            font-family: "Caveat", cursive;
            font-size: 1.3rem;
            line-height: 1.8;
            color: var(--ink);
        }

        .letter-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: center;
        }

        /* Write View */
        .write-container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: flex-start;
        }

        .write-form {
            flex: 1;
            background: var(--cream);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 12px 40px var(--paper-shadow);
            background-image: 
                repeating-linear-gradient(
                    transparent,
                    transparent 24px,
                    rgba(111, 122, 92, 0.1) 25px,
                    rgba(111, 122, 92, 0.1) 26px
                );
        }

        .customization-sidebar {
            width: 300px;
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px var(--paper-shadow);
            backdrop-filter: blur(10px);
            max-height: 80vh;
            overflow-y: auto;
            margin-top: 120px;
        }

        .sidebar-title {
            font-family: 'Caveat', cursive;
            font-size: 1.5rem;
            color: var(--moss);
            margin-bottom: 20px;
            text-align: center;
        }

        .customization-panel {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
        }

        .custom-section {
            margin-bottom: 20px;
        }

        .custom-section h4 {
            font-family: 'Caveat', cursive;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--moss);
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .option-btn {
            width: 60px;
            height: 60px;
            border: 2px solid var(--dusty-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: white;
            position: relative;
        }

        .option-btn.active {
            border-color: var(--moss);
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-btn.active {
            transform: scale(1.2);
            border-color: var(--ink);
        }

        .letter-content {
            position: relative;
            min-height: 300px;
            padding: 20px;
            border: 1px solid var(--dusty-blue);
            border-radius: 6px;
            background: rgba(255,255,255,0.8);
        }

        .letter-decorations {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .letter-images {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .letter-images img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--paper-shadow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: var(--moss);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--dusty-blue);
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            background: rgba(255,255,255,0.8);
        }

        /* Paper Styles */
        .paper-vintage { 
            background: linear-gradient(135deg, #f4f1de 0%, #e9dcc9 100%);
        }
        .paper-typewriter { 
            background: #f8f6f0;
            background-image: repeating-linear-gradient(transparent, transparent 23px, #d4af37 23px, #d4af37 24px);
        }
        .paper-telegram { 
            background: #fff8dc;
            background-image: 
                linear-gradient(90deg, #daa520 0px, #daa520 2px, transparent 2px),
                repeating-linear-gradient(transparent, transparent 19px, #daa520 19px, #daa520 20px);
        }

        .decoration-preview {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .decoration-item {
            background: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .image-upload {
            border: 2px dashed var(--dusty-blue);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload input {
            display: none;
        }

        .uploaded-images {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .uploaded-image {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--paper-shadow);
        }

        .uploaded-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--faded-rose);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--moss);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--paper-shadow);
            z-index: 1000;
            animation: toastSlide 3s ease-in-out;
        }

        @keyframes toastSlide {
            0%, 100% { transform: translateX(300px); opacity: 0; }
            10%, 90% { transform: translateX(0); opacity: 1; }
        }

        /* Code Modal */
        .code-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .code-modal-content {
            background: var(--cream);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .code-display {
            background: var(--moss);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.3em;
            margin: 20px 0;
            font-family: 'Special Elite', monospace;
        }

        .code-modal h2 {
            font-family: 'Caveat', cursive;
            font-size: 2rem;
            color: var(--moss);
            margin-bottom: 15px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .write-container {
                flex-direction: column;
            }
            
            .customization-sidebar {
                width: 100%;
                max-height: none;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="club-title">Digital Mail Club</h1>
            <p class="privacy-label">Send letters to anyone</p>
        </div>

        <div id="mailbox-view" class="view active">
            <div class="mailbox">
                <div class="envelope" onclick="openLetter()" role="button" tabindex="0" aria-label="Open letter">
                    <div class="envelope-front">
                        <div class="postage-area"></div>
                        <div class="addressee">Your Mailbox</div>
                    </div>
                    <div class="envelope-flap"></div>
                    <div class="wax-seal"></div>
                    <div class="unread-badge" id="unread-count">0</div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="showView('write')">Write New</button>
                    <button class="btn btn-secondary" onclick="showView('receive')">Receive Letter</button>
                    <button class="btn btn-tertiary" onclick="showView('received')">Received Letters</button>
                </div>
            </div>
        </div>

        <div id="letter-view" class="view">
            <div class="letter-view">
                <div class="letter-card" id="letter-content"></div>
                <div class="letter-actions">
                    <button class="btn btn-secondary" onclick="replyToLetter()">Reply</button>
                    <button class="btn btn-primary" onclick="closeLetter()">Close Letter</button>
                </div>
            </div>
        </div>

        <div id="write-view" class="view">
            <div class="write-container">
                <form id="letter-form" class="write-form" onsubmit="sendLetter(event)">
                    <h2>Write a Letter</h2>
                    <div class="form-group">
                        <label for="to-field">To:</label>
                        <input type="text" id="to-field" required placeholder="Enter recipient name">
                    </div>
                    <div class="form-group">
                        <label for="subject-field">Subject:</label>
                        <input type="text" id="subject-field" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="letter-content">Your Letter:</label>
                        <div class="letter-content" id="letter-content">
                            <div class="letter-decorations" id="letter-decorations"></div>
                            <textarea id="body-field" required placeholder="Dear friend..." oninput="updateLetter()" style="border: none; background: transparent; width: 100%; resize: none; outline: none; font-family: inherit; font-size: inherit; color: inherit; line-height: inherit; min-height: 300px;"></textarea>
                            <div class="letter-images" id="letter-images"></div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button type="submit" class="btn btn-primary">Seal & Send</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelWriting(); return false;">Cancel</button>
                        <button type="button" class="btn btn-tertiary" onclick="showView('mailbox'); return false;">Return to Homepage</button>
                    </div>
                </form>
                
                <div class="customization-sidebar">
                    <h3 class="sidebar-title">✨ Customize Letter</h3>
                    
                    <div class="customization-panel">
                        <div class="custom-section">
                            <h4>📜 Paper Style</h4>
                            <div class="option-grid">
                                <div class="option-btn active" data-paper="vintage" title="Vintage Parchment">📜</div>
                                <div class="option-btn" data-paper="typewriter" title="Typewriter Paper">⌨️</div>
                                <div class="option-btn" data-paper="telegram" title="Telegram Form">📠</div>
                            </div>
                        </div>
                        
                        <div class="custom-section">
                            <h4>✍️ Font Style</h4>
                            <div class="option-grid">
                                <div class="option-btn active" data-font="caveat" title="Handwritten">
                                    <div style="font-family: 'Caveat', cursive; font-size: 0.8rem;">Aa</div>
                                </div>
                                <div class="option-btn" data-font="special-elite" title="Typewriter">
                                    <div style="font-family: 'Special Elite', monospace; font-size: 0.8rem;">Aa</div>
                                </div>
                                <div class="option-btn" data-font="serif" title="Classic Serif">
                                    <div style="font-family: serif; font-size: 0.8rem;">Aa</div>
                                </div>
                                <div class="option-btn" data-font="cursive" title="Elegant Script">
                                    <div style="font-family: cursive; font-size: 0.8rem;">Aa</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="custom-section">
                            <h4>🎨 Text Color</h4>
                            <div class="option-grid">
                                <div class="color-btn active" data-color="#3B3A39" style="background: #3B3A39;" title="Ink Black"></div>
                                <div class="color-btn" data-color="#6C7A5C" style="background: #6C7A5C;" title="Forest Green"></div>
                                <div class="color-btn" data-color="#7FA3B2" style="background: #7FA3B2;" title="Ocean Blue"></div>
                                <div class="color-btn" data-color="#C98088" style="background: #C98088;" title="Rose Pink"></div>
                            </div>
                        </div>
                        
                        <div class="custom-section">
                            <h4>✨ Decorations</h4>
                            <div class="option-grid">
                                <div class="option-btn" data-decoration="🌟">🌟</div>
                                <div class="option-btn" data-decoration="💖">💖</div>
                                <div class="option-btn" data-decoration="🌸">🌸</div>
                                <div class="option-btn" data-decoration="🦋">🦋</div>
                            </div>
                            <div class="decoration-preview" id="decoration-preview"></div>
                        </div>
                        
                        <div class="custom-section">
                            <h4>📷 Add Images</h4>
                            <div class="image-upload" onclick="document.getElementById('image-input').click()">
                                <input type="file" id="image-input" accept="image/*" multiple onchange="handleImageUpload(event)">
                                <div>📷 Click to upload images</div>
                            </div>
                            <div class="uploaded-images" id="uploaded-images"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="receive-view" class="view">
            <div class="write-form" style="max-width: 600px; margin: 0 auto;">
                <h2>Receive Letter</h2>
                <p style="margin-bottom: 20px; color: var(--moss);">Got a letter code from someone? Enter it below:</p>
                <div class="form-group">
                    <label for="letter-code">6-Digit Code:</label>
                    <input type="text" id="letter-code" placeholder="ABC123" maxlength="6" style="text-transform: uppercase; text-align: center; font-size: 1.5rem; letter-spacing: 0.2em;">
                </div>
                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="receiveLetter()">Open Letter</button>
                    <button class="btn btn-secondary" onclick="showView('mailbox')">Back to Mailbox</button>
                </div>
            </div>
        </div>

        <div id="received-view" class="view">
            <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                <h2>Received Letters</h2>
                <div id="received-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;"></div>
                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="showView('mailbox')">Back to Mailbox</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App state
        let state = {
            letters: [],
            currentLetter: null
        };

        // Customization state
        let selectedPaper = 'vintage';
        let selectedFont = 'caveat';
        let selectedColor = '#3B3A39';
        let selectedDecorations = [];
        let uploadedImages = [];

        // Initialize app
        function initializeApp() {
            const savedState = localStorage.getItem('digitalMailClub');
            if (savedState) {
                state = JSON.parse(savedState);
            }
            updateUI();
        }

        function saveState() {
            localStorage.setItem('digitalMailClub', JSON.stringify(state));
        }

        function updateUI() {
            updateUnreadCount();
            updateReceivedLetters();
            updateMailboxDisplay();
        }

        function updateUnreadCount() {
            const unreadCount = state.letters.filter(letter => !letter.read && letter.received).length;
            const badge = document.getElementById('unread-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateMailboxDisplay() {
            const envelope = document.querySelector('.envelope');
            const unreadCount = state.letters.filter(letter => !letter.read && letter.received).length;
            
            if (unreadCount === 0) {
                envelope.style.opacity = '0.5';
                envelope.style.cursor = 'default';
            } else {
                envelope.style.opacity = '1';
                envelope.style.cursor = 'pointer';
            }
        }

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewName + '-view').classList.add('active');

            if (viewName === 'write') {
                setupWriteForm();
                setTimeout(updateLetter, 100);
            } else if (viewName === 'received') {
                updateReceivedLetters();
            }
        }

        function openLetter() {
            const envelope = document.querySelector('.envelope');
            const unreadLetters = state.letters.filter(letter => !letter.read && letter.received);

            if (unreadLetters.length > 0) {
                envelope.classList.add('opening');
                const letter = unreadLetters[0];
                letter.read = true;
                state.currentLetter = letter;
                saveState();

                setTimeout(() => {
                    displayLetter(letter);
                    showView('letter');
                    envelope.classList.remove('opening');
                    updateMailboxDisplay();
                }, 900);
            } else {
                showToast('No new letters in your mailbox!');
            }
        }

        function displayLetter(letter) {
            const content = document.getElementById('letter-content');
            const date = new Date(letter.dateISO).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            if (letter.paperStyle) {
                content.className = `letter-card paper-${letter.paperStyle}`;
            }

            let decorationsHtml = '';
            if (letter.decorations && letter.decorations.length > 0) {
                decorationsHtml = `<div style="text-align: center; font-size: 1.5rem; margin-bottom: 15px;">${letter.decorations.join(' ')}</div>`;
            }

            let imagesHtml = '';
            if (letter.images && letter.images.length > 0) {
                imagesHtml = '<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">';
                letter.images.forEach(img => {
                    imagesHtml += `<img src="${img}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px var(--paper-shadow);" alt="Attached image">`;
                });
                imagesHtml += '</div>';
            }

            const fontFamily = letter.fontStyle ? getFontFamily(letter.fontStyle) : "'Caveat', cursive";
            const textColor = letter.textColor || 'var(--ink)';

            content.innerHTML = `
                <div class="letter-meta">
                    <div>From: <strong>${letter.from}</strong></div>
                    <div>${date}</div>
                </div>
                ${decorationsHtml}
                <h3 style="font-family: ${fontFamily}; font-size: 1.5rem; margin-bottom: 15px; color: var(--moss);">${letter.subject}</h3>
                <div class="letter-body" style="font-family: ${fontFamily}; color: ${textColor};">${letter.body.replace(/\n/g, '<br>')}</div>
                ${imagesHtml}
            `;
        }

        function generateCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function setupWriteForm(isReply = false, originalLetter = null) {
            const toField = document.getElementById('to-field');
            const subjectField = document.getElementById('subject-field');
            const bodyField = document.getElementById('body-field');

            if (isReply && originalLetter) {
                toField.value = originalLetter.from;
                subjectField.value = originalLetter.subject.startsWith('Re: ') ? originalLetter.subject : `Re: ${originalLetter.subject}`;
                bodyField.value = `\n\n---\nReplying to: "${originalLetter.subject}" from ${originalLetter.from}`;
                bodyField.focus();
                bodyField.setSelectionRange(0, 0);
            } else {
                toField.value = '';
                subjectField.value = '';
                bodyField.value = '';
                setTimeout(() => toField.focus(), 100);
            }
        }

        function closeLetter() {
            showView('mailbox');
        }

        function sendLetter(event) {
            event.preventDefault();
            
            const to = document.getElementById('to-field').value.trim();
            const subject = document.getElementById('subject-field').value.trim();
            const body = document.getElementById('body-field').value.trim();

            if (!to || !subject || !body) {
                showToast('Please fill in all fields');
                return false;
            }

            const letterCode = generateCode();
            const newLetter = {
                id: 'letter_' + Date.now(),
                from: 'You',
                to: to,
                subject: subject,
                body: body,
                dateISO: new Date().toISOString(),
                read: false,
                code: letterCode,
                paperStyle: selectedPaper,
                fontStyle: selectedFont,
                textColor: selectedColor,
                decorations: [...selectedDecorations],
                images: [...uploadedImages]
            };

            let sharedLetters = JSON.parse(localStorage.getItem('sharedLetters')) || {};
            sharedLetters[letterCode] = newLetter;
            localStorage.setItem('sharedLetters', JSON.stringify(sharedLetters));

            state.letters.push(newLetter);
            saveState();

            const submitBtn = document.querySelector('#letter-form button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sealing...';
            
            setTimeout(() => {
                showCodeModal(letterCode, to);
                resetWriteForm();
                showView('mailbox');
                updateUI();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Seal & Send';
            }, 1500);

            return false;
        }

        function showCodeModal(code, recipient) {
            const modal = document.createElement('div');
            modal.className = 'code-modal';
            modal.innerHTML = `
                <div class="code-modal-content">
                    <h2>Letter Sent! 💌</h2>
                    <p>Share this code with ${recipient}:</p>
                    <div class="code-display">${code}</div>
                    <p style="font-size: 0.9rem; color: var(--moss); margin-bottom: 20px;">They can use this code in "Receive Letter" to read your message.</p>
                    <button class="btn btn-primary" onclick="closeCodeModal()">Got it!</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeCodeModal() {
            const modal = document.querySelector('.code-modal');
            if (modal) {
                modal.remove();
            }
        }

        function receiveLetter() {
            const code = document.getElementById('letter-code').value.trim().toUpperCase();
            
            if (!code) {
                showToast('Please enter a letter code!');
                return;
            }

            const sharedLetters = JSON.parse(localStorage.getItem('sharedLetters')) || {};
            const letter = sharedLetters[code];
            
            if (!letter) {
                showToast('Invalid code! Please check and try again.');
                return;
            }

            const existingLetter = state.letters.find(l => l.code === code && l.from !== 'You');
            if (existingLetter) {
                showToast('Letter already received!');
                return;
            }
            
            const receivedLetter = {
                ...letter,
                id: 'received_' + Date.now(),
                read: false,
                received: true
            };
            
            state.letters.push(receivedLetter);
            saveState();
            
            document.getElementById('letter-code').value = '';
            showToast('Letter received! Check your mailbox.');
            
            setTimeout(() => {
                showView('mailbox');
                updateUI();
            }, 1500);
        }

        function resetWriteForm() {
            document.getElementById('to-field').value = '';
            document.getElementById('subject-field').value = '';
            document.getElementById('body-field').value = '';
            document.getElementById('letter-form').reset();
            
            selectedPaper = 'vintage';
            selectedFont = 'caveat';
            selectedColor = '#3B3A39';
            selectedDecorations = [];
            uploadedImages = [];
            
            document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-paper="vintage"]').classList.add('active');
            document.querySelector('[data-font="caveat"]').classList.add('active');
            document.querySelector('[data-color="#3B3A39"]').classList.add('active');
            
            updateLetter();
            updateDecorationPreview();
            updateUploadedImages();
        }

        function cancelWriting() {
            resetWriteForm();
            showView('mailbox');
        }

        function updateReceivedLetters() {
            const grid = document.getElementById('received-grid');
            if (!grid) return;
            
            const receivedLetters = state.letters.filter(letter => letter.received || letter.from !== 'You');

            if (receivedLetters.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; font-family: \'Caveat\', cursive; font-size: 1.2rem; color: var(--moss); opacity: 0.7;">No received letters yet. Check your mailbox for new mail!</div>';
                return;
            }

            grid.innerHTML = receivedLetters.map(letter => {
                const date = new Date(letter.dateISO).toLocaleDateString();
                return `
                    <div style="background: var(--kraft); border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--paper-shadow);" onclick="openReceivedLetter('${letter.id}')" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                        <h3 style="font-family: 'Caveat', cursive; font-size: 1.2rem; margin-bottom: 5px; color: var(--ink);">${letter.subject}</h3>
                        <p style="font-size: 0.8rem; color: var(--moss); opacity: 0.8;">From: ${letter.from} • ${date}</p>
                        <p style="font-size: 0.8rem; color: var(--moss); opacity: 0.8;">${letter.body.substring(0, 100)}${letter.body.length > 100 ? '...' : ''}</p>
                    </div>
                `;
            }).join('');
        }

        function openReceivedLetter(letterId) {
            const letter = state.letters.find(l => l.id === letterId);
            if (letter) {
                state.currentLetter = letter;
                displayLetter(letter);
                showView('letter');
            }
        }

        function replyToLetter() {
            if (state.currentLetter) {
                setupWriteForm(true, state.currentLetter);
                showView('write');
            }
        }

        function initializeCustomization() {
            document.querySelectorAll('[data-paper]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-paper]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedPaper = this.dataset.paper;
                    updateLetter();
                });
            });

            document.querySelectorAll('[data-font]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-font]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedFont = this.dataset.font;
                    updateLetter();
                });
            });

            document.querySelectorAll('[data-color]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-color]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedColor = this.dataset.color;
                    updateLetter();
                });
            });

            document.querySelectorAll('[data-decoration]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const decoration = this.dataset.decoration;
                    if (!selectedDecorations.includes(decoration)) {
                        selectedDecorations.push(decoration);
                        updateDecorationPreview();
                        updateLetter();
                    }
                });
            });
        }

        function updateLetter() {
            const letterContent = document.getElementById('letter-content');
            const letterDecorations = document.getElementById('letter-decorations');
            const letterImages = document.getElementById('letter-images');
            const bodyField = document.getElementById('body-field');
            const writeForm = document.querySelector('.write-form');
            
            if (!letterContent || !bodyField) return;
            
            writeForm.className = `write-form paper-${selectedPaper}`;
            letterContent.className = `letter-content paper-${selectedPaper}`;
            
            const fontFamily = getFontFamily(selectedFont);
            letterContent.style.fontFamily = fontFamily;
            letterContent.style.color = selectedColor;
            bodyField.style.fontFamily = fontFamily;
            bodyField.style.color = selectedColor;
            
            if (letterDecorations) {
                letterDecorations.textContent = selectedDecorations.join(' ');
            }
            
            if (letterImages) {
                letterImages.innerHTML = uploadedImages.map(img => 
                    `<img src="${img}" alt="Letter image">`
                ).join('');
            }
            
            bodyField.style.height = 'auto';
            bodyField.style.height = Math.max(200, bodyField.scrollHeight) + 'px';
        }

        function updateDecorationPreview() {
            const preview = document.getElementById('decoration-preview');
            
            preview.innerHTML = selectedDecorations.map(decoration => 
                `<span class="decoration-item" onclick="removeDecoration('${decoration}')">${decoration}</span>`
            ).join('');
        }

        function removeDecoration(decoration) {
            selectedDecorations = selectedDecorations.filter(d => d !== decoration);
            updateDecorationPreview();
            updateLetter();
        }

        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages.push(e.target.result);
                        updateUploadedImages();
                        updateLetter();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function updateUploadedImages() {
            const container = document.getElementById('uploaded-images');
            
            container.innerHTML = uploadedImages.map((img, index) => `
                <div class="uploaded-image">
                    <img src="${img}" alt="Uploaded image">
                    <button class="remove-image" onclick="removeImage(${index})">×</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateUploadedImages();
            updateLetter();
        }

        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        function getFontFamily(fontStyle) {
            const fonts = {
                'caveat': "'Caveat', cursive",
                'special-elite': "'Special Elite', monospace",
                'serif': 'serif',
                'cursive': 'cursive'
            };
            return fonts[fontStyle] || "'Caveat', cursive";
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            initializeCustomization();
        });
    </script>
</body>
</html>
